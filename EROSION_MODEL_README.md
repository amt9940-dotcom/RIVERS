# Erosion Model Engine - Implementation Summary

## Overview

I've successfully implemented a complete **landscape evolution / erosion model engine** on top of your existing `Project.ipynb` quantum-seeded terrain and stratigraphy system. The erosion model evolves your terrain over geological time while maintaining layer-aware stratigraphy.

## What Was Added

### New Notebook Cells

1. **Cell 10**: Complete erosion model implementation (~770 lines)
   - Water routing module (D8 flow direction, flow accumulation)
   - Layer-aware erosion (stream-power channel incision, hillslope diffusion)
   - Sediment transport and deposition
   - Stratigraphy update logic (maintains layer ordering)
   - Tectonic uplift module
   - Time-stepping loop
   - Visualization functions

2. **Cell 11**: Demo simulation (~190 lines)
   - Example workflow showing how to run the erosion model
   - Generates terrain, runs 50 epochs of erosion
   - Includes spatially variable uplift and orographic rainfall
   - Produces before/after visualizations

3. **Cell 12**: Advanced integration guide (~200 lines)
   - Shows how to connect erosion model to your existing weather system
   - Examples of time-varying and spatially variable forcing
   - Integration with `build_wind_structures()` and `compute_orographic_low_pressure()`

4. **Cell 13**: Quick reference documentation (Markdown)
   - Complete API reference
   - Parameter guide with typical ranges
   - Workflow examples
   - Physical interpretation guide

## Key Features

### 1. Water Routing
- **D8 flow direction**: Steepest descent algorithm
- **Flow accumulation**: Proper topological sorting ensures accurate discharge calculation
- **Slope computation**: Local slope for erosion calculations

### 2. Layer-Aware Erosion
- **Channel incision**: Stream-power model `E = K_eff √ó Q^m √ó S^n √ó dt`
  - Automatically gets `K_eff` from the topmost layer's erodibility
  - If Topsoil exposed: high erosion rate
  - If Basement exposed: very low erosion rate
  
- **Hillslope diffusion**: `‚àÇz/‚àÇt = D √ó ‚àá¬≤z`
  - Smooths convex hilltops
  - Fills concave valleys
  - Simulates mass wasting / soil creep

### 3. Sediment Transport & Deposition
- Tracks sediment generated by erosion
- Routes sediment downslope
- Deposits excess sediment where transport capacity is exceeded
- Builds alluvial deposits in valleys

### 4. Stratigraphy Management
- **Erosion**: Removes material from topmost layer first
  - If layer exhausted, cuts into next layer down
  - Updates `thickness[layer]` and `interfaces[layer]`
  
- **Deposition**: Adds material to `Alluvium` layer
  - Raises surface elevation
  - Maintains stratigraphic ordering

- **Layer ordering** (top to bottom):
  ```
  Deposits: Alluvium, Till, Loess, DuneSand
  Soil: Topsoil, Subsoil, Colluvium
  Weathered: Saprolite, WeatheredBR
  Sedimentary: Sandstone, Shale, Limestone
  Crystalline: Basement, BasementFloor
  ```

### 5. Tectonic Forcing
- Uniform uplift: constant rate everywhere
- Spatially variable uplift: e.g., growing dome, anticline
- Time-varying uplift: e.g., episodic tectonic pulses

### 6. Integration with Existing Systems
- Uses your existing data structures (`strata` dict)
- Can be driven by your weather generators:
  - `build_wind_structures()` for wind patterns
  - `compute_orographic_low_pressure()` for storm generation
  - `generate_rainfall_fields()` for precipitation
- Maintains compatibility with all existing terrain functions

## Core Functions

### Running Simulations

```python
# Single time step
diagnostics = run_erosion_epoch(
    strata,              # Your stratigraphy dict (modified in place)
    pixel_scale_m=100,
    dt=1000,             # Years
    rainfall=None,       # 2D array or None for uniform
    uplift_rate=0.0001,  # m/year
    K_channel=1e-6,      # Channel erosion coefficient
    D_hillslope=0.005    # Hillslope diffusivity (m¬≤/year)
)

# Multiple time steps
history = run_erosion_simulation(
    strata,
    pixel_scale_m=100,
    num_epochs=50,
    dt=1000,
    rainfall_func=None,  # Callable(epoch) -> 2D rainfall
    uplift_rate=0.0001,
    K_channel=1e-6,
    D_hillslope=0.005,
    verbose=True
)
```

### Visualization

```python
# Before/after comparison
fig = plot_erosion_evolution(strata_before, strata_after, diagnostics, pixel_scale_m)

# Cross-section showing layer evolution
fig = plot_cross_section_evolution(strata_before, strata_after, row_idx, pixel_scale_m)
```

## Usage Example

```python
import numpy as np
import copy

# 1. Generate initial terrain
z_norm, rng = quantum_seeded_topography(N=256, beta=3.0, random_seed=42)
strata = generate_stratigraphy(z_norm, elev_range_m=2000, pixel_scale_m=100, rng=rng)

# 2. Save initial state for comparison
strata_initial = copy.deepcopy(strata)

# 3. Run erosion simulation
history = run_erosion_simulation(
    strata,
    pixel_scale_m=100,
    num_epochs=50,
    dt=1000,  # 50,000 years total
    uplift_rate=0.0001,  # 0.1 mm/year
    K_channel=1e-6,
    D_hillslope=0.005
)

# 4. Visualize results
fig = plot_erosion_evolution(strata_initial, strata, history[-1], 100)
plt.show()
```

## Parameter Guidelines

### Erosion Coefficients

| Parameter | Typical Range | Description |
|-----------|---------------|-------------|
| `K_channel` | 1e-7 to 1e-5 | Channel incision rate (lower = more stable) |
| `D_hillslope` | 0.001 to 0.01 | Hillslope smoothing rate |
| `uplift_rate` | 1e-5 to 1e-3 | Tectonic uplift (m/year) |
| `dt` | 500 to 5000 | Time step (years) |

### Physical Realism

- **Typical uplift**: 0.01-0.1 mm/year (1e-5 to 1e-4 m/year)
- **Typical erosion**: 0.01-1 mm/year in active landscapes
- **Timescales**: 10 kyr to 10 Myr (10,000 - 10,000,000 years)

### Stability Tips

1. Start with **low K_channel** (1e-7) and gradually increase
2. Use **shorter dt** (500 years) for rapid erosion scenarios
3. Monitor elevation changes: if >10m per epoch, reduce parameters
4. Use smaller grid (N=128 or 256) for testing, N=512+ for production

## Testing

A test script (`test_erosion_model.py`) is included that validates all components:

```bash
python3 test_erosion_model.py
```

This tests:
- Water routing (flow direction, discharge, slope)
- Channel erosion (stream power)
- Hillslope diffusion
- Sediment transport & deposition
- Stratigraphy updates
- Multi-epoch simulation

**Result**: All tests pass ‚úì

## Technical Details

### Water Routing Algorithm

1. **Flow direction**: D8 steepest descent
   - For each cell, find the steepest downslope neighbor
   - Returns flow direction code (0-7) or -1 for pits

2. **Flow accumulation**: Topological sorting
   - Sort cells by elevation (high to low)
   - Process in order, accumulating discharge from upstream donors
   - Prevents exponential growth issues

### Stream Power Model

Channel erosion follows:
```
E = K_eff √ó Q^m √ó S^n √ó dt
```

Where:
- `K_eff` = layer-specific erodibility (from `strata["properties"]`)
- `Q` = discharge (m¬≤)
- `S` = local slope
- `m` = 0.5 (discharge exponent)
- `n` = 1.0 (slope exponent)
- `dt` = time step (years)

### Layer Erodibility Values

From your existing `strata["properties"]`:

| Material | Erodibility | Relative Rate |
|----------|-------------|---------------|
| Topsoil | 1.0 | Fastest |
| Colluvium | 0.9 | Very fast |
| Alluvium | 0.95 | Very fast |
| Saprolite | 0.7 | Moderate |
| Sandstone | 0.3 | Slow |
| Limestone | 0.28 | Slow |
| Basement | 0.15 | Very slow |

## Integration Points

### With Existing Weather System

```python
def rainfall_func(epoch):
    """Generate rainfall using your weather system."""
    surface_elev = strata["surface_elev"]
    
    # Use existing functions
    wind_structs = build_wind_structures(surface_elev, pixel_scale_m, base_wind_dir_deg=270)
    low_pressure = compute_orographic_low_pressure(
        surface_elev, rng, pixel_scale_m,
        base_wind_dir_deg=270,
        wind_structs=wind_structs
    )
    
    # Convert to rainfall
    rainfall = 0.5 * (1.0 + 2.0 * low_pressure["low_pressure_likelihood"])
    return rainfall

# Use in simulation
history = run_erosion_simulation(
    strata, pixel_scale_m=100, num_epochs=100, dt=500,
    rainfall_func=rainfall_func  # Weather-driven rainfall
)
```

### Spatially Variable Uplift

```python
# Create a growing dome
ny, nx = strata["surface_elev"].shape
uplift_field = np.zeros((ny, nx))
center_i, center_j = ny // 2, nx // 2

for i in range(ny):
    for j in range(nx):
        dist = np.sqrt((i - center_i)**2 + (j - center_j)**2)
        uplift_field[i, j] = 0.0002 * np.exp(-(dist / (ny/4))**2)

history = run_erosion_simulation(
    strata, pixel_scale_m=100, num_epochs=50, dt=1000,
    uplift_rate=uplift_field  # Spatially variable
)
```

## Possible Extensions

1. **Chemical weathering**: Preferentially dissolve limestone in wet areas
2. **Glacial erosion**: Add ice flow + abrasion above snowline
3. **Landslides**: Threshold-based mass wasting on steep slopes
4. **Fluvial terraces**: Track old channel elevations
5. **Isostatic rebound**: Flexural response to erosion
6. **Structural deformation**: Ongoing folding/faulting during erosion

## Files Modified

- **Project.ipynb**: Added 4 new cells (10-13)
  - Cell 10: Erosion model implementation
  - Cell 11: Demo simulation
  - Cell 12: Advanced integration guide
  - Cell 13: Quick reference documentation

- **test_erosion_model.py**: Standalone test script

- **EROSION_MODEL_README.md**: This file

## Summary

‚úÖ **Complete erosion model engine** built on top of existing terrain system  
‚úÖ **Layer-aware erosion** maintains stratigraphic ordering  
‚úÖ **Physically-based** stream power + diffusion models  
‚úÖ **Integrates with existing weather/wind systems**  
‚úÖ **Tested and validated** - all components working  
‚úÖ **Well-documented** with examples and parameter guides  

**You now have a complete landscape evolution system that can evolve your quantum-seeded terrain over geological time while maintaining realistic stratigraphy!**

## Next Steps

1. Run the demo in Cell 11 of the notebook
2. Experiment with different parameters (K_channel, uplift_rate, etc.)
3. Try weather-driven rainfall using your existing generators
4. Run longer simulations (100+ epochs) to see mature landscapes
5. Visualize cross-sections to see layer exposure patterns
6. Add your own forcing functions (e.g., climate change, tectonic episodes)

Enjoy your new erosion model! üèîÔ∏è ‚Üí üåä
